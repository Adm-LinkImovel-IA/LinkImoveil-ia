<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurar Perfil - LinkImóvel IA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; padding: 40px 0; }
        .profile-container { max-width: 650px; margin: auto; background: white; padding: 35px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .btn-save { background: #22c55e; border: none; color: white; font-weight: 700; padding: 14px; transition: 0.3s; }
        .btn-save:hover { background: #16a34a; transform: scale(1.01); }
        .section-title { border-left: 5px solid #2563eb; padding-left: 15px; margin-bottom: 25px; font-weight: 800; color: #1e293b; }
        .required-label::after { content: " *"; color: red; }
    </style>
</head>
<body>

<div class="container">
    <div class="profile-container">
        <h3 class="section-title">Meu Perfil Profissional</h3>
        <p class="text-muted small mb-4">Campos com * são obrigatórios para liberar a captura por IA.</p>
        
        <form id="profile-form">
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label required-label">Nome Completo</label>
                    <input type="text" id="nome" class="form-control" required>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label required-label">Cidade de Atuação</label>
                    <input type="text" id="cidade" class="form-control" placeholder="Ex: São Paulo" required>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label required-label">Estado (UF)</label>
                    <select id="uf" class="form-select" required>
                        <option value="">Selecione...</option>
                        <option value="AC">Acre</option> <option value="AL">Alagoas</option> <option value="AP">Amapá</option>
                        <option value="AM">Amazonas</option> <option value="BA">Bahia</option> <option value="CE">Ceará</option>
                        <option value="DF">Distrito Federal</option> <option value="ES">Espírito Santo</option> <option value="GO">Goiás</option>
                        <option value="MA">Maranhão</option> <option value="MT">Mato Grosso</option> <option value="MS">Mato Grosso do Sul</option>
                        <option value="MG">Minas Gerais</option> <option value="PA">Pará</option> <option value="PB">Paraíba</option>
                        <option value="PR">Paraná</option> <option value="PE">Pernambuco</option> <option value="PI">Piauí</option>
                        <option value="RJ">Rio de Janeiro</option> <option value="RN">Rio Grande do Norte</option> <option value="RS">Rio Grande do Sul</option>
                        <option value="RO">Rondônia</option> <option value="RR">Roraima</option> <option value="SC">Santa Catarina</option>
                        <option value="SP">São Paulo</option> <option value="SE">Sergipe</option> <option value="TO">Tocantins</option>
                    </select>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label required-label">WhatsApp (Com DDD)</label>
                    <input type="text" id="whatsapp" class="form-control" placeholder="(00) 90000-0000" required>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label required-label">CRECI</label>
                    <input type="text" id="creci" class="form-control" placeholder="12345-F" required>
                </div>
            </div>

            <hr class="my-4">

            <h5 class="fw-bold mb-3">Configurações de Comissão</h5>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label required-label">Sua % de Comissão Padrão (Regulamentada)</label>
                    <div class="input-group">
                        <input type="number" id="comissao_padrao" class="form-control" value="6.00" step="0.1" required>
                        <span class="input-group-text">%</span>
                    </div>
                    <small class="text-muted">Geralmente 6% para venda urbana.</small>
                </div>
            </div>

            <button type="submit" class="btn btn-save w-100 mt-4">SALVAR E ATIVAR CAPTURA</button>
        </form>
        
        <div class="text-center mt-4">
            <button onclick="logout()" class="btn btn-link text-danger btn-sm text-decoration-none">Sair da conta</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // CHAVES DO SUPABASE
    const supabaseUrl = 'https://xmjxfcwnytguwntvloja.supabase.co'; 
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtanhmY3dueXRndXdudHZsb2phIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMzA4MDEsImV4cCI6MjA4NTgwNjgwMX0.HSJbuCrnL7D3AlEpqlxq28yowHmUlqZyQSOCJRrmgOM';
    const supabase = supabasejs.createClient(supabaseUrl, supabaseKey);

    async function loadProfile() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) { window.location.href = 'login.html'; return; }

        const { data: perfil } = await supabase
            .from('usuarios')
            .select('*')
            .eq('id', user.id)
            .single();

        if (perfil) {
            document.getElementById('nome').value = perfil.nome || '';
            document.getElementById('cidade').value = perfil.cidade || '';
            document.getElementById('uf').value = perfil.uf || '';
            document.getElementById('whatsapp').value = perfil.whatsapp || '';
            document.getElementById('creci').value = perfil.creci || '';
            document.getElementById('comissao_padrao').value = perfil.percentual_comissao_padrao || 6.00;
        }
    }

    document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const { data: { user } } = await supabase.auth.getUser();

        const updates = {
            id: user.id,
            nome: document.getElementById('nome').value,
            cidade: document.getElementById('cidade').value,
            uf: document.getElementById('uf').value,
            whatsapp: document.getElementById('whatsapp').value,
            creci: document.getElementById('creci').value,
            percentual_comissao_padrao: document.getElementById('comissao_padrao').value,
            updated_at: new Date()
        };

        const { error } = await supabase.from('usuarios').upsert(updates);

        if (error) {
            alert("Erro ao salvar: " + error.message);
        } else {
            alert("Perfil ativado! Agora você pode usar a extensão para capturar imóveis.");
            // Opcional: Redirecionar para o Dashboard/Gestão
            // window.location.href = 'gestao.html';
        }
    });

    async function logout() {
        await supabase.auth.signOut();
        window.location.href = 'login.html';
    }

    loadProfile();
</script>
</body>
</html>